generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String       @id @default(uuid())
  name           String
  slug           String       @unique
  username       String?      @unique
  password       String?
  prize          String       @default("Premio Sorpresa")
  requiredVisits Int          @default(10)
  rewardPeriod   RewardPeriod @default(OPEN)

  // ðŸ”“ SIN UNIQUE POR AHORA PARA PASAR EL DEPLOY
  codePrefix String?

  lat       Float?  @default(19.4326)
  lng       Float?  @default(-99.1332)
  address   String? @default("DirecciÃ³n pendiente")
  instagram String?
  logoData  String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())

  users       TenantUser[]
  memberships Membership[]
  dailyCodes  DailyCode[]
  redemptions Redemption[]
  walletStyle TenantWalletStyle?
  pushLogs    TenantPushLog[]
}

model TenantUser {
  id             String      @id @default(uuid())
  name           String
  phone          String
  email          String
  username       String      @unique
  password       String
  role           String
  tenantId       String
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  generatedCodes DailyCode[] @relation("DailyCodeGeneratedBy")
}

model User {
  id          String       @id @default(uuid())
  phone       String       @unique
  email       String?
  password    String       @default("1234")
  name        String?
  gender      String?
  birthDate   DateTime?
  createdAt   DateTime     @default(now())
  memberships Membership[]
  redemptions Redemption[]
}

model Membership {
  id            String       @id @default(uuid())
  currentVisits Int          @default(0)
  periodKey     String       @default("OPEN")
  periodType    RewardPeriod @default(OPEN)
  totalVisits   Int          @default(0)
  lastVisitAt   DateTime?
  tenantId      String
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  visits        Visit[]

  @@unique([tenantId, userId])
}

model DailyCode {
  id        String   @id @default(uuid())
  code      String
  day       String // YYYY-MM-DD (para reglas/uniques)
  validDate DateTime @default(now())
  isActive  Boolean  @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  generatedById String
  generatedBy   TenantUser @relation("DailyCodeGeneratedBy", fields: [generatedById], references: [id], onDelete: Cascade)

  visits Visit[]

  @@unique([tenantId, generatedById, day])
}

model Visit {
  id        String   @id @default(uuid())
  visitedAt DateTime @default(now())

  // para evitar mÃºltiples scans en el mismo dÃ­a por negocio
  visitDay String // YYYY-MM-DD
  tenantId String

  membershipId String
  membership   Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  dailyCodeId String
  dailyCode   DailyCode @relation(fields: [dailyCodeId], references: [id])

  @@unique([membershipId, tenantId, visitDay])
}

model Redemption {
  id        String   @id @default(uuid())
  code      String
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model TenantPushLog {
  id        String   @id @default(uuid())
  tenantId  String
  message   String
  devices   Int      @default(0)
  sentAt    DateTime @default(now()) @map("sent_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_push_logs")
}

model TenantWalletStyle {
  tenantId       String   @id @map("tenant_id")
  backgroundColor String  @default("rgb(31,41,55)") @map("background_color")
  foregroundColor String  @default("rgb(255,255,255)") @map("foreground_color")
  labelColor      String  @default("rgb(191,219,254)") @map("label_color")
  stripImageData  String   @default("") @map("strip_image_data")
  lastPushMessage String   @default("") @map("last_push_message")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")
  createdAt       DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_wallet_styles")
}

enum RewardPeriod {
  OPEN
  MONTHLY
  QUARTERLY
  SEMESTER
  ANNUAL
}
